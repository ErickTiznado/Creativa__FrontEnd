import React from 'react';
import './CampaignWorkspace.css';
import './ImgGenerated.css';
import { CircleUser, Menu } from 'lucide-react';
import { useCampaignWorkspace } from '../../hooks/useCampaignWorkspace';
import { useSavedAssets } from '../../hooks/useSavedAssets';

import RepositoryView from '../../components/RepositoryView/RepositoryView';
import GeneratorView from '../../components/GeneratorView/GeneratorView';
import SavedAssetsView from '../../components/SavedAssetsView/SavedAssetsView';
import ImageUser from '../../components/ImageUser/ImageUser';

const CampaignWorkspace = () => {
    const userStr = localStorage.getItem('user');
    //console.log("Usuario almacenado en localStorage:", userStr);
    const user = userStr ? JSON.parse(userStr) : null;
    let nameUser = user?.firstName || "US";
    nameUser = nameUser.substring(0, 2).toUpperCase();
    //console.log("Iniciales del usuario para Avatar:", nameUser);
    const {
        // Data
        campaignData,
        campaign,

        // UI State
        activeTab, setActiveTab,
        isSidebarOpen, setIsSidebarOpen,

        // Repository
        assets, loadingAssets, selectedIds, toggleSelection,
        handleDeleteAsset, handleApproveAsset,

        // Generator
        prompt, setPrompt,
        style, setStyle,
        useReference, setUseReference,
        aspectRatio, setAspectRatio,
        imageSize, setImageSize,
        quantity, setQuantity,
        generatedImages, handleGenerate,
        isGenerating, generationError,
        getRefinements,
    } = useCampaignWorkspace();

    // Single instance of saved assets â€” passed as props to children (DRY)
    const { savedAssets, loading: savedLoading, toggleSaveAsset } = useSavedAssets(campaign?.id);

    return (
        <div className='cw-layout'>
            {/* Overlay for mobile when sidebar is open */}
            <div
                className={`cw-overlay ${isSidebarOpen ? 'visible' : ''}`}
                onClick={() => setIsSidebarOpen(false)}
            />

            {/* Sidebar */}
            <aside className={`cw-sidebar ${isSidebarOpen ? 'open' : 'closed'}`}>
                <div className='cw-profile'>
                    {/* <ImageUserDesinger Initials={nameUser}/> */}
                    <ImageUser Initials={nameUser} name="UserDesingerImg" nameContainer="imgUserDesinger" />
                    {/* <CircleUser className='cw-avatar' size={80} strokeWidth={1.5} /> */}
                    {/* <h3 className='cw-user-name'>{campaignData.designer}</h3> */}
                    <h3 className='cw-user-name'>{user.firstName + " " + user.lastName}</h3>
                </div>

                <nav className='cw-nav-menu'>
                    <button
                        className={`cw-nav-item ${activeTab === 'Repositorio' ? 'active' : ''}`}
                        onClick={() => setActiveTab('Repositorio')}
                    >
                        Repositorio
                    </button>
                    <button
                        className={`cw-nav-item ${activeTab === 'Generador' ? 'active' : ''}`}
                        onClick={() => setActiveTab('Generador')}
                    >
                        Generador Img
                    </button>
                    <button
                        className={`cw-nav-item ${activeTab === 'Assets' ? 'active' : ''}`}
                        onClick={() => setActiveTab('Assets')}
                    >
                        Assets
                    </button>
                </nav>
            </aside>

            <main className='cw-main-content'>
                <header className='cw-header'>
                    <div className='cw-header-left'>
                        <button
                            className="cw-toggle-sidebar"
                            onClick={() => setIsSidebarOpen(!isSidebarOpen)}
                            aria-label="Toggle sidebar"
                        >
                            <Menu />
                        </button>
                        <h1 className='cw-title'>{campaignData.title}</h1>
                        <span className='cw-status'>{campaignData.status}</span>
                    </div>
                </header>

                {activeTab === 'Repositorio' && (
                    <RepositoryView
                        campaignData={campaignData}
                        selectedIds={selectedIds}
                        toggleSelection={toggleSelection}
                        assets={assets}
                        loading={loadingAssets}
                        onDelete={handleDeleteAsset}
                    />
                )}

                {activeTab === 'Generador' && (
                    <GeneratorView
                        designerName={campaignData.designer}
                        prompt={prompt}
                        setPrompt={setPrompt}
                        style={style}
                        setStyle={setStyle}
                        useReference={useReference}
                        setUseReference={setUseReference}
                        aspectRatio={aspectRatio}
                        setAspectRatio={setAspectRatio}
                        imageSize={imageSize}
                        setImageSize={setImageSize}
                        quantity={quantity}
                        setQuantity={setQuantity}
                        handleGenerate={handleGenerate}
                        generatedImages={generatedImages}
                        referenceImages={assets.filter(asset => selectedIds.includes(asset.id))}
                        onDeselectReference={toggleSelection}
                        savedAssets={savedAssets}
                        onToggleSaveAsset={toggleSaveAsset}
                        isGenerating={isGenerating}
                        generationError={generationError}
                        getRefinements={getRefinements}
                        onDelete={handleDeleteAsset}
                        campaignId={campaign?.id}
                    />
                )}

                {activeTab === 'Assets' && (
                    <SavedAssetsView
                        campaignId={campaign?.id}
                        savedAssets={savedAssets}
                        loading={savedLoading}
                        toggleSaveAsset={toggleSaveAsset}
                        onApprove={handleApproveAsset}
                    />
                )}
            </main>
        </div>
    );
};

export default CampaignWorkspace;